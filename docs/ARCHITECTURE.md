# KV Store Service Architecture

## High-Level Overview

The **KV Store Service** is a high-performance, **multi-tenant**, **multi-region**, **multi-cluster** gRPC-based caching service designed for **KV (Key-Value) offload** in large language model inference scenarios. It runs in the **Azure Platform Subscription** and provides a **unified endpoint** for model providers to work with multiple customer storage accounts without requiring individual Private Link (PLINK) connections from each inference node.

### Key Characteristics

| Characteristic | Description |
|----------------|-------------|
| **Multi-Tenant** | Serves multiple customers/model providers from shared infrastructure |
| **Multi-Region** | Deployed across Azure regions for low-latency global access |
| **Multi-Cluster** | Each region contains multiple clusters for scalability and HA |
| **Cluster Composition** | Array of Windows VMs, each running 2 NUMA-pinned processes |

---

## Global Deployment Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                   AZURE PLATFORM SUBSCRIPTION                                           │
│                                  (Multi-Tenant KV Store Service)                                        │
│                                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐│
│  │                                    GLOBAL CONTROL PLANE                                             ││
│  │                                                                                                     ││
│  │   ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐                        ││
│  │   │   Traffic Manager   │  │  Account Registry   │  │  Cluster Registry   │                        ││
│  │   │   / Azure FrontDoor │  │  (Customer → Region │  │  (Health, Capacity) │                        ││
│  │   │                     │  │   → Cluster mapping)│  │                     │                        ││
│  │   └──────────┬──────────┘  └─────────────────────┘  └─────────────────────┘                        ││
│  │              │                                                                                      ││
│  └──────────────┼──────────────────────────────────────────────────────────────────────────────────────┘│
│                 │                                                                                       │
│    ┌────────────┴────────────┬──────────────────────────┬──────────────────────────┐                   │
│    ▼                         ▼                          ▼                          ▼                   │
│  ┌─────────────────────────────┐  ┌─────────────────────────────┐  ┌─────────────────────────────┐     │
│  │      REGION: WEST US        │  │      REGION: EAST US        │  │     REGION: WEST EUROPE     │     │
│  │                             │  │                             │  │                             │     │
│  │  ┌───────────────────────┐  │  │  ┌───────────────────────┐  │  │  ┌───────────────────────┐  │     │
│  │  │     Cluster #1        │  │  │  │     Cluster #1        │  │  │  │     Cluster #1        │  │     │
│  │  │  ┌─────┐ ┌─────┐     │  │  │  │  ┌─────┐ ┌─────┐     │  │  │  │  ┌─────┐ ┌─────┐     │  │     │
│  │  │  │VM-1 │ │VM-2 │ ... │  │  │  │  │VM-1 │ │VM-2 │ ... │  │  │  │  │VM-1 │ │VM-2 │ ... │  │     │
│  │  │  └─────┘ └─────┘     │  │  │  │  └─────┘ └─────┘     │  │  │  │  └─────┘ └─────┘     │  │     │
│  │  └───────────────────────┘  │  │  └───────────────────────┘  │  │  └───────────────────────┘  │     │
│  │                             │  │                             │  │                             │     │
│  │  ┌───────────────────────┐  │  │  ┌───────────────────────┐  │  │  ┌───────────────────────┐  │     │
│  │  │     Cluster #2        │  │  │  │     Cluster #2        │  │  │  │     Cluster #2        │  │     │
│  │  │  ┌─────┐ ┌─────┐     │  │  │  │  ┌─────┐ ┌─────┐     │  │  │  │  ┌─────┐ ┌─────┐     │  │     │
│  │  │  │VM-1 │ │VM-2 │ ... │  │  │  │  │VM-1 │ │VM-2 │ ... │  │  │  │  │VM-1 │ │VM-2 │ ... │  │     │
│  │  │  └─────┘ └─────┘     │  │  │  │  └─────┘ └─────┘     │  │  │  │  └─────┘ └─────┘     │  │     │
│  │  └───────────────────────┘  │  │  └───────────────────────┘  │  │  └───────────────────────┘  │     │
│  │            ...              │  │            ...              │  │            ...              │     │
│  │  ┌───────────────────────┐  │  │  ┌───────────────────────┐  │  │  ┌───────────────────────┐  │     │
│  │  │     Cluster #N        │  │  │  │     Cluster #N        │  │  │  │     Cluster #N        │  │     │
│  │  └───────────────────────┘  │  │  └───────────────────────┘  │  │  └───────────────────────┘  │     │
│  │                             │  │                             │  │                             │     │
│  └─────────────────────────────┘  └─────────────────────────────┘  └─────────────────────────────┘     │
│                                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Cluster Architecture (Per-Region)

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                         KV STORE CLUSTER                                                │
│                                    (Array of Windows VMs)                                               │
│                                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                    Load Balancer                                                │   │
│   │                         (Distributes traffic across VMs)                                        │   │
│   └───────────────────────────────────────────┬─────────────────────────────────────────────────────┘   │
│                                               │                                                         │
│       ┌───────────────────────────────────────┼───────────────────────────────────────┐                 │
│       │                       │               │               │                       │                 │
│       ▼                       ▼               ▼               ▼                       ▼                 │
│   ┌───────────┐           ┌───────────┐   ┌───────────┐   ┌───────────┐           ┌───────────┐        │
│   │   VM #1   │           │   VM #2   │   │   VM #3   │   │   VM #4   │           │   VM #N   │        │
│   │ FX96mds   │           │ FX96mds   │   │ FX96mds   │   │ FX96mds   │    ...    │ FX96mds   │        │
│   │           │           │           │   │           │   │           │           │           │        │
│   │ ┌───────┐ │           │ ┌───────┐ │   │ ┌───────┐ │   │ ┌───────┐ │           │ ┌───────┐ │        │
│   │ │:8085  │ │           │ │:8085  │ │   │ │:8085  │ │   │ │:8085  │ │           │ │:8085  │ │        │
│   │ │NUMA 0 │ │           │ │NUMA 0 │ │   │ │NUMA 0 │ │   │ │NUMA 0 │ │           │ │NUMA 0 │ │        │
│   │ │48 core│ │           │ │48 core│ │   │ │48 core│ │   │ │48 core│ │           │ │48 core│ │        │
│   │ └───────┘ │           │ └───────┘ │   │ └───────┘ │   │ └───────┘ │           │ └───────┘ │        │
│   │ ┌───────┐ │           │ ┌───────┐ │   │ ┌───────┐ │   │ ┌───────┐ │           │ ┌───────┐ │        │
│   │ │:8086  │ │           │ │:8086  │ │   │ │:8086  │ │   │ │:8086  │ │           │ │:8086  │ │        │
│   │ │NUMA 1 │ │           │ │NUMA 1 │ │   │ │NUMA 1 │ │   │ │NUMA 1 │ │           │ │NUMA 1 │ │        │
│   │ │48 core│ │           │ │48 core│ │   │ │48 core│ │   │ │48 core│ │           │ │48 core│ │        │
│   │ └───────┘ │           │ └───────┘ │   │ └───────┘ │   │ └───────┘ │           │ └───────┘ │        │
│   │           │           │           │   │           │   │           │           │           │        │
│   │ Multi-NIC │           │ Multi-NIC │   │ Multi-NIC │   │ Multi-NIC │           │ Multi-NIC │        │
│   └─────┬─────┘           └─────┬─────┘   └─────┬─────┘   └─────┬─────┘           └─────┬─────┘        │
│         │                       │               │               │                       │              │
│         └───────────────────────┴───────────────┴───────────────┴───────────────────────┘              │
│                                                 │                                                       │
│                                                 ▼                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                              Customer Storage Accounts                                          │   │
│   │                        (Multiple accounts across tenants)                                       │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## VM Architecture (2 Processes per VM)

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              WINDOWS VM (FX96mds_v2 - 96 cores, 2 NUMA nodes)                           │
│                                                                                                         │
│   ┌────────────────────────────────────────────┐   ┌────────────────────────────────────────────┐       │
│   │           NUMA NODE 0 (48 cores)           │   │           NUMA NODE 1 (48 cores)           │       │
│   │                                            │   │                                            │       │
│   │   ┌────────────────────────────────────┐   │   │   ┌────────────────────────────────────┐   │       │
│   │   │      KVStoreServer Process #1      │   │   │   │      KVStoreServer Process #2      │   │       │
│   │   │           (Port 8085)              │   │   │   │           (Port 8086)              │   │       │
│   │   │                                    │   │   │   │                                    │   │       │
│   │   │   start /NODE 0 KVStoreServer.exe  │   │   │   │   start /NODE 1 KVStoreServer.exe  │   │       │
│   │   │                                    │   │   │   │                                    │   │       │
│   │   │   ┌────────────────────────────┐   │   │   │   │   ┌────────────────────────────┐   │   │       │
│   │   │   │    gRPC Async Server       │   │   │   │   │   │    gRPC Async Server       │   │   │       │
│   │   │   │   (HTTP/2 + Callback API)  │   │   │   │   │   │   (HTTP/2 + Callback API)  │   │   │       │
│   │   │   └─────────────┬──────────────┘   │   │   │   │   └─────────────┬──────────────┘   │   │       │
│   │   │                 │                  │   │   │   │                 │                  │   │       │
│   │   │   ┌─────────────▼──────────────┐   │   │   │   │   ┌─────────────▼──────────────┐   │   │       │
│   │   │   │   KVStoreServiceImpl       │   │   │   │   │   │   KVStoreServiceImpl       │   │   │       │
│   │   │   │   • AccountResolver        │   │   │   │   │   │   • AccountResolver        │   │   │       │
│   │   │   │   • Reactor Pool           │   │   │   │   │   │   • Reactor Pool           │   │   │       │
│   │   │   │   • Store Cache            │   │   │   │   │   │   • Store Cache            │   │   │       │
│   │   │   └─────────────┬──────────────┘   │   │   │   │   └─────────────┬──────────────┘   │   │       │
│   │   │                 │                  │   │   │   │                 │                  │   │       │
│   │   │   ┌─────────────▼──────────────┐   │   │   │   │   ┌─────────────▼──────────────┐   │   │       │
│   │   │   │ AzureStorageKVStoreLibV2   │   │   │   │   │   │ AzureStorageKVStoreLibV2   │   │   │       │
│   │   │   │ (Bloom Filter + Cache)     │   │   │   │   │   │ (Bloom Filter + Cache)     │   │   │       │
│   │   │   └────────────────────────────┘   │   │   │   │   └────────────────────────────┘   │   │       │
│   │   │                                    │   │   │   │                                    │   │       │
│   │   └────────────────────────────────────┘   │   │   └────────────────────────────────────┘   │       │
│   │                                            │   │                                            │       │
│   │   Local Memory: ~256GB                     │   │   Local Memory: ~256GB                     │       │
│   │   No cross-NUMA penalty                    │   │   No cross-NUMA penalty                    │       │
│   │                                            │   │                                            │       │
│   └────────────────────────────────────────────┘   └────────────────────────────────────────────┘       │
│                                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                   Network Interface Cards                                       │   │
│   │         ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐          │   │
│   │         │NIC 0 │  │NIC 1 │  │NIC 2 │  │NIC 3 │  │NIC 4 │  │NIC 5 │  │NIC 6 │  │NIC 7 │          │   │
│   │         └──┬───┘  └──┬───┘  └──┬───┘  └──┬───┘  └──┬───┘  └──┬───┘  └──┬───┘  └──┬───┘          │   │
│   │            └─────────┴─────────┴─────────┴────┬────┴─────────┴─────────┴─────────┘              │   │
│   │                                               │                                                 │   │
│   │                                      Round-Robin to Storage                                     │   │
│   └───────────────────────────────────────────────┼─────────────────────────────────────────────────┘   │
│                                                   │                                                     │
└───────────────────────────────────────────────────┼─────────────────────────────────────────────────────┘
                                                    │
                                                    ▼
                                         Azure Blob Storage
```

---

## Multi-Tenant Request Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                     MULTI-TENANT REQUEST FLOW                                           │
│                                                                                                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                                          │
│  │   Customer A    │  │   Customer B    │  │   Customer C    │   ... (Multiple Tenants)                │
│  │   (Inference)   │  │   (Inference)   │  │   (Inference)   │                                          │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘                                          │
│           │                    │                    │                                                    │
│           │  resource_name:    │  resource_name:    │  resource_name:                                   │
│           │  "custA-storage"   │  "custB-storage"   │  "custC-storage"                                  │
│           │                    │                    │                                                    │
│           └────────────────────┴────────────────────┘                                                    │
│                                │                                                                         │
│                                ▼                                                                         │
│  ┌──────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                            KV STORE SERVICE (Platform Subscription)                              │   │
│  │                                                                                                  │   │
│  │   ┌──────────────────────────────────────────────────────────────────────────────────────────┐   │   │
│  │   │                              Account Resolver                                            │   │   │
│  │   │                                                                                          │   │   │
│  │   │   ┌────────────────┐      ┌────────────────┐      ┌────────────────┐                     │   │   │
│  │   │   │ "custA-storage"│      │ "custB-storage"│      │ "custC-storage"│                     │   │   │
│  │   │   │       ↓        │      │       ↓        │      │       ↓        │                     │   │   │
│  │   │   │  custA-storage │      │  custB-storage │      │  custC-storage │                     │   │   │
│  │   │   │  .blob.core    │      │  .blob.core    │      │  .blob.core    │                     │   │   │
│  │   │   │  .windows.net  │      │  .windows.net  │      │  .windows.net  │                     │   │   │
│  │   │   └───────┬────────┘      └───────┬────────┘      └───────┬────────┘                     │   │   │
│  │   │           │                       │                       │                              │   │   │
│  │   └───────────┼───────────────────────┼───────────────────────┼──────────────────────────────┘   │   │
│  │               │                       │                       │                                  │   │
│  │               ▼                       ▼                       ▼                                  │   │
│  │   ┌────────────────────────────────────────────────────────────────────────────────────────┐     │   │
│  │   │                        Azure Blob Storage (Customer Subscriptions)                     │     │   │
│  │   │                                                                                        │     │   │
│  │   │    ┌──────────────────┐   ┌──────────────────┐   ┌──────────────────┐                 │     │   │
│  │   │    │  Customer A      │   │  Customer B      │   │  Customer C      │                 │     │   │
│  │   │    │  Storage Account │   │  Storage Account │   │  Storage Account │    ...          │     │   │
│  │   │    │  (KV Container)  │   │  (KV Container)  │   │  (KV Container)  │                 │     │   │
│  │   │    └──────────────────┘   └──────────────────┘   └──────────────────┘                 │     │   │
│  │   │                                                                                        │     │   │
│  │   └────────────────────────────────────────────────────────────────────────────────────────┘     │   │
│  │                                                                                                  │   │
│  └──────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Single VM Detail

The following diagram shows the internal architecture of a single VM within a cluster:

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    AZURE PLATFORM SUBSCRIPTION                                          │
│  ┌───────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              KV Store Service (Unified Endpoint)                                  │  │
│  │                                                                                                   │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                         Windows VM (e.g., FX96mds_v2 - 96 cores)                            │  │  │
│  │  │                                                                                             │  │  │
│  │  │   ┌──────────────────────────────────┐   ┌──────────────────────────────────┐              │  │  │
│  │  │   │      KVStoreServer :8085         │   │      KVStoreServer :8086         │              │  │  │
│  │  │   │     (NUMA Node 0 - 48 cores)     │   │     (NUMA Node 1 - 48 cores)     │              │  │  │
│  │  │   │                                  │   │                                  │              │  │  │
│  │  │   │  ┌────────────────────────────┐  │   │  ┌────────────────────────────┐  │              │  │  │
│  │  │   │  │     gRPC Async Server      │  │   │  │     gRPC Async Server      │  │              │  │  │
│  │  │   │  │   (Callback API + HTTP/2)  │  │   │  │   (Callback API + HTTP/2)  │  │              │  │  │
│  │  │   │  └────────────┬───────────────┘  │   │  └────────────┬───────────────┘  │              │  │  │
│  │  │   │               │                  │   │               │                  │              │  │  │
│  │  │   │  ┌────────────▼───────────────┐  │   │  ┌────────────▼───────────────┐  │              │  │  │
│  │  │   │  │   KVStoreServiceImpl       │  │   │  │   KVStoreServiceImpl       │  │              │  │  │
│  │  │   │  │  ┌──────────────────────┐  │  │   │  │  ┌──────────────────────┐  │  │              │  │  │
│  │  │   │  │  │   AccountResolver    │  │  │   │  │  │   AccountResolver    │  │  │              │  │  │
│  │  │   │  │  │  (resource → store)  │  │  │   │  │  │  (resource → store)  │  │  │              │  │  │
│  │  │   │  │  └──────────────────────┘  │  │   │  │  └──────────────────────┘  │  │              │  │  │
│  │  │   │  │  ┌──────────────────────┐  │  │   │  │  ┌──────────────────────┐  │  │              │  │  │
│  │  │   │  │  │    Reactor Pool      │  │  │   │  │  │    Reactor Pool      │  │  │              │  │  │
│  │  │   │  │  │ Lookup|Read|Write    │  │  │   │  │  │ Lookup|Read|Write    │  │  │              │  │  │
│  │  │   │  │  │ StreamingRead        │  │  │   │  │  │ StreamingRead        │  │  │              │  │  │
│  │  │   │  │  └──────────────────────┘  │  │   │  │  └──────────────────────┘  │  │              │  │  │
│  │  │   │  └────────────┬───────────────┘  │   │  └────────────┬───────────────┘  │              │  │  │
│  │  │   │               │                  │   │               │                  │              │  │  │
│  │  │   │  ┌────────────▼───────────────┐  │   │  ┌────────────▼───────────────┐  │              │  │  │
│  │  │   │  │ AzureStorageKVStoreLibV2   │  │   │  │ AzureStorageKVStoreLibV2   │  │              │  │  │
│  │  │   │  │  (Bloom Filter + Cache)    │  │   │  │  (Bloom Filter + Cache)    │  │              │  │  │
│  │  │   │  └────────────────────────────┘  │   │  └────────────────────────────┘  │              │  │  │
│  │  │   └──────────────────────────────────┘   └──────────────────────────────────┘              │  │  │
│  │  │                        │                                   │                               │  │  │
│  │  │                        │  Multi-NIC Round Robin           │                               │  │  │
│  │  │                        │  (libcurl transport)              │                               │  │  │
│  │  │                        ▼                                   ▼                               │  │  │
│  │  │   ┌──────────────────────────────────────────────────────────────────────────────────────┐ │  │  │
│  │  │   │                              Network Interface Cards                                 │ │  │  │
│  │  │   │    ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐     │ │  │  │
│  │  │   │    │  NIC 0  │  │  NIC 1  │  │  NIC 2  │  │  NIC 3  │  │  NIC 4  │  │  NIC 5  │     │ │  │  │
│  │  │   │    └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘     │ │  │  │
│  │  │   └─────────┼────────────┼────────────┼────────────┼────────────┼────────────┼──────────┘ │  │  │
│  │  │             │            │            │            │            │            │            │  │  │
│  │  └─────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼────────────┘  │  │
│  │                │            │            │            │            │            │               │  │
│  └────────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼───────────────┘  │
│                   │            │            │            │            │            │                  │
│                   └────────────┼────────────┼────────────┼────────────┼────────────┘                  │
│                                │            │            │            │                               │
│                                ▼            ▼            ▼            ▼                               │
│  ┌──────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                              Azure Blob Storage Accounts                                          │ │
│  │                                                                                                   │ │
│  │   ┌───────────────────┐ ┌───────────────────┐ ┌───────────────────┐ ┌───────────────────┐        │ │
│  │   │  Storage Acct A   │ │  Storage Acct B   │ │  Storage Acct C   │ │  Storage Acct D   │  ...   │ │
│  │   │  (Customer 1)     │ │  (Customer 2)     │ │  (Customer 3)     │ │  (Customer 4)     │        │ │
│  │   │                   │ │                   │ │                   │ │                   │        │ │
│  │   │ ┌───────────────┐ │ │ ┌───────────────┐ │ │ ┌───────────────┐ │ │ ┌───────────────┐ │        │ │
│  │   │ │ KV Container  │ │ │ │ KV Container  │ │ │ │ KV Container  │ │ │ │ KV Container  │ │        │ │
│  │   │ │ (Token Chunks)│ │ │ │ (Token Chunks)│ │ │ │ (Token Chunks)│ │ │ │ (Token Chunks)│ │        │ │
│  │   │ └───────────────┘ │ │ └───────────────┘ │ │ └───────────────┘ │ │ └───────────────┘ │        │ │
│  │   └───────────────────┘ └───────────────────┘ └───────────────────┘ └───────────────────┘        │ │
│  │                                                                                                   │ │
│  └──────────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                       │
└───────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                             ▲
                                             │  gRPC (HTTP/2)
                                             │  Single PLINK per provider
                                             │
┌───────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                MODEL PROVIDER INFRASTRUCTURE                                          │
│                                                                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                            Inference Node Cluster (Linux)                                       │  │
│  │                                                                                                 │  │
│  │  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐                     │  │
│  │  │   Inference Node 1  │  │   Inference Node 2  │  │   Inference Node N  │                     │  │
│  │  │   ┌───────────────┐ │  │   ┌───────────────┐ │  │   ┌───────────────┐ │                     │  │
│  │  │   │   LLM Model   │ │  │   │   LLM Model   │ │  │   │   LLM Model   │ │                     │  │
│  │  │   │  (GPT/etc.)   │ │  │   │  (GPT/etc.)   │ │  │   │  (GPT/etc.)   │ │                     │  │
│  │  │   └───────┬───────┘ │  │   └───────┬───────┘ │  │   └───────┬───────┘ │                     │  │
│  │  │           │         │  │           │         │  │           │         │                     │  │
│  │  │   ┌───────▼───────┐ │  │   ┌───────▼───────┐ │  │   ┌───────▼───────┐ │                     │  │
│  │  │   │   KVClient    │ │  │   │   KVClient    │ │  │   │   KVClient    │ │                     │  │
│  │  │   │  (gRPC stub)  │ │  │   │  (gRPC stub)  │ │  │   │  (gRPC stub)  │ │                     │  │
│  │  │   └───────────────┘ │  │   └───────────────┘ │  │   └───────────────┘ │                     │  │
│  │  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘                     │  │
│  │                                                                                                 │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                       │
└───────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Key Value Propositions

### 1. **Unified Endpoint (PLINK Reduction)**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         WITHOUT KV STORE SERVICE                            │
│                                                                             │
│   Inference Node ──PLINK──► Storage Account A (Customer 1)                  │
│   Inference Node ──PLINK──► Storage Account B (Customer 2)                  │
│   Inference Node ──PLINK──► Storage Account C (Customer 3)                  │
│   Inference Node ──PLINK──► Storage Account D (Customer 4)                  │
│                     ...                                                     │
│   Inference Node ──PLINK──► Storage Account N (Customer N)                  │
│                                                                             │
│   ⚠️  N PLINKs required = Complex management, high cost                     │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                          WITH KV STORE SERVICE                              │
│                                                                             │
│   Inference Node ─────┐                                                     │
│   Inference Node ─────┼── 1 PLINK ──► KV Store ──► Storage Account A        │
│   Inference Node ─────┤   Service      Service     Storage Account B        │
│   Inference Node ─────┤                            Storage Account C        │
│   Inference Node ─────┘                            Storage Account D        │
│                                                    Storage Account N        │
│                                                                             │
│   ✅  1 PLINK required = Simple management, low cost                        │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2. **Account Resolution Flow**

```
┌────────────────────────────────────────────────────────────────────────────────────────┐
│                              ACCOUNT RESOLUTION FLOW                                   │
│                                                                                        │
│  ┌──────────────┐      resource_name       ┌─────────────────────┐                     │
│  │   KVClient   │ ──────────────────────► │   KVStoreServer     │                     │
│  │              │   "mystorageaccount"     │                     │                     │
│  └──────────────┘                          │  ┌─────────────────────────────────────┐  │
│                                            │  │        IAccountResolver             │  │
│                                            │  │                                     │  │
│                                            │  │  ┌─────────────────────────────┐    │  │
│                                            │  │  │  InMemoryAccountResolver    │    │  │
│                                            │  │  │                             │    │  │
│                                            │  │  │  resource_name              │    │  │
│                                            │  │  │      +                      │    │  │
│                                            │  │  │  ".blob.core.windows.net"   │    │  │
│                                            │  │  │      =                      │    │  │
│                                            │  │  │  Full Account URL           │    │  │
│                                            │  │  └─────────────────────────────┘    │  │
│                                            │  │                                     │  │
│                                            │  │  ┌─────────────────────────────┐    │  │
│                                            │  │  │  DatabaseAccountResolver    │    │  │
│                                            │  │  │  (FUTURE)                   │    │  │
│                                            │  │  │                             │    │  │
│                                            │  │  │  • Customer account lookup  │    │  │
│                                            │  │  │  • Cross-region routing     │    │  │
│                                            │  │  │  • Access control           │    │  │
│                                            │  │  └─────────────────────────────┘    │  │
│                                            │  └─────────────────────────────────────┘  │
│                                            │                                           │
│                                            │  Returns: AzureStorageKVStoreLibV2        │
│                                            │          (connected to resolved account)  │
│                                            └───────────────────────────────────────────┘
│                                                                                        │
└────────────────────────────────────────────────────────────────────────────────────────┘
```

### 3. **Cross-Region Cache Offload (Future)**

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                         CROSS-REGION CACHE OFFLOAD (FUTURE)                             │
│                                                                                         │
│  ┌─────────────────────────────────────┐    ┌─────────────────────────────────────┐     │
│  │           REGION: WEST US           │    │          REGION: EAST US            │     │
│  │                                     │    │                                     │     │
│  │  ┌───────────────────────────────┐  │    │  ┌───────────────────────────────┐  │     │
│  │  │     KV Store Service          │  │    │  │     KV Store Service          │  │     │
│  │  │                               │  │    │  │                               │  │     │
│  │  │  ┌─────────────────────────┐  │◄─┼────┼─►│  ┌─────────────────────────┐  │  │     │
│  │  │  │    Cross-Region Cache   │  │  │    │  │  │    Cross-Region Cache   │  │  │     │
│  │  │  │      Replicator         │  │  │    │  │  │      Replicator         │  │  │     │
│  │  │  └─────────────────────────┘  │  │    │  │  └─────────────────────────┘  │  │     │
│  │  │                               │  │    │  │                               │  │     │
│  │  └───────────────┬───────────────┘  │    │  └───────────────┬───────────────┘  │     │
│  │                  │                  │    │                  │                  │     │
│  │                  ▼                  │    │                  ▼                  │     │
│  │  ┌───────────────────────────────┐  │    │  ┌───────────────────────────────┐  │     │
│  │  │   Local Storage Accounts      │  │    │  │   Local Storage Accounts      │  │     │
│  │  │   (Low latency access)        │  │    │  │   (Low latency access)        │  │     │
│  │  └───────────────────────────────┘  │    │  └───────────────────────────────┘  │     │
│  │                                     │    │                                     │     │
│  │  ┌───────────────────────────────┐  │    │  ┌───────────────────────────────┐  │     │
│  │  │   Inference Nodes             │  │    │  │   Inference Nodes             │  │     │
│  │  └───────────────────────────────┘  │    │  └───────────────────────────────┘  │     │
│  │                                     │    │                                     │     │
│  └─────────────────────────────────────┘    └─────────────────────────────────────┘     │
│                                                                                         │
│  Benefits:                                                                              │
│  • Cache warming across regions                                                         │
│  • Reduced cold start latency for multi-region deployments                              │
│  • Global cache coherence for shared prompt patterns                                    │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Component Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              KV STORE SERVER COMPONENTS                                 │
│                                                                                         │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                    server.cpp                                     │  │
│  │                                                                                   │  │
│  │   Command Line Options:                                                           │  │
│  │   --port 8085                     Listen port                                     │  │
│  │   --host 0.0.0.0                  Bind address                                    │  │
│  │   --threads N                     Worker threads (auto-detect)                    │  │
│  │   --blob-dns-suffix .blob...      Account URL suffix                              │  │
│  │   --log-level error               Logging verbosity                               │  │
│  │   --transport libcurl             HTTP transport (winhttp|libcurl)                │  │
│  │   --enable-multi-nic              Multi-NIC round-robin                           │  │
│  │                                                                                   │  │
│  └───────────────────────────────────────────────────────────────────────────────────┘  │
│                                           │                                             │
│                                           ▼                                             │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│  │                            KVStoreServiceImpl                                     │  │
│  │                                                                                   │  │
│  │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                   │  │
│  │   │ IAccountResolver │  │  gRPC Reactors  │  │   Store Cache   │                   │  │
│  │   │                 │  │                 │  │                 │                   │  │
│  │   │ ResolveStore()  │  │ LookupReactor   │  │ resource_name → │                   │  │
│  │   │                 │  │ ReadReactor     │  │ KVStoreLib ptr  │                   │  │
│  │   │                 │  │ WriteReactor    │  │                 │                   │  │
│  │   │                 │  │ StreamingRead   │  │                 │                   │  │
│  │   └─────────────────┘  └─────────────────┘  └─────────────────┘                   │  │
│  │                                                                                   │  │
│  └───────────────────────────────────────────────────────────────────────────────────┘  │
│                                           │                                             │
│                                           ▼                                             │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│  │                        AzureStorageKVStoreLibV2                                   │  │
│  │                                                                                   │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────┐ │  │
│  │   │                           Core Operations                                   │ │  │
│  │   │                                                                             │ │  │
│  │   │   Lookup()         Find cached token blocks using Bloom filter              │ │  │
│  │   │   ReadAsync()      Retrieve chunk by blob location                          │ │  │
│  │   │   WriteAsync()     Store new chunk to blob storage                          │ │  │
│  │   │   StreamingRead()  Batch read with bidirectional streaming                  │ │  │
│  │   │                                                                             │ │  │
│  │   └─────────────────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                                   │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────┐ │  │
│  │   │                         Performance Features                                │ │  │
│  │   │                                                                             │ │  │
│  │   │   • Bloom Filter      O(1) cache miss detection                             │ │  │
│  │   │   • 128-Token Blocks  Optimal chunk size for GPT                            │ │  │
│  │   │   • Connection Pool   100 concurrent HTTP connections                       │ │  │
│  │   │   • DNS Caching       300s TTL reduces DNS lookups                          │ │  │
│  │   │   • SSL Session       Reuse for faster TLS handshakes                       │ │  │
│  │   │                                                                             │ │  │
│  │   └─────────────────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                                   │  │
│  └───────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## gRPC Protocol

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                  gRPC SERVICE DEFINITION                                │
│                                                                                         │
│   service KVStoreService {                                                              │
│                                                                                         │
│     // Unary RPCs                                                                       │
│     ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│     │  rpc Lookup(LookupRequest) returns (LookupResponse)                             │ │
│     │      • Find cached token blocks matching sequence                               │ │
│     │      • Returns: cached_blocks, locations[], last_hash                           │ │
│     │      • Uses Bloom filter for O(1) cache miss                                    │ │
│     └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                         │
│     ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│     │  rpc Read(ReadRequest) returns (ReadResponse)                                   │ │
│     │      • Retrieve chunk by blob location                                          │ │
│     │      • Returns: PromptChunk (tokens, buffer, hash)                              │ │
│     │      • Typical payload: ~1.2MB per chunk                                        │ │
│     └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                         │
│     ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│     │  rpc Write(WriteRequest) returns (WriteResponse)                                │ │
│     │      • Store new chunk to blob storage                                          │ │
│     │      • Input: PromptChunk with tokens and KV buffer                             │ │
│     │      • Creates blob with hash-based naming                                      │ │
│     └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                         │
│     // Bidirectional Streaming RPC                                                      │
│     ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│     │  rpc StreamingRead(stream ReadRequest) returns (stream ReadResponse)            │ │
│     │      • Pipeline multiple reads with reduced round-trips                         │ │
│     │      • Client sends all requests, then receives all responses                   │ │
│     │      • Parallel storage access on server side                                   │ │
│     │      • Latency = max(individual reads) instead of sum                           │ │
│     └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                         │
│   }                                                                                     │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Data Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              TYPICAL KV OFFLOAD FLOW                                    │
│                                                                                         │
│   ┌───────────────────┐                                                                 │
│   │  1. MODEL START   │  LLM receives prompt tokens for inference                       │
│   │     [tokens...]   │                                                                 │
│   └─────────┬─────────┘                                                                 │
│             │                                                                           │
│             ▼                                                                           │
│   ┌───────────────────┐                                                                 │
│   │  2. LOOKUP        │  KVClient.Lookup(resource_name, partition, tokens)              │
│   │                   │  → gRPC → Server → Bloom Filter → Storage                       │
│   │                   │  ← Returns: cached_blocks=5, locations=[loc1..loc5]             │
│   └─────────┬─────────┘                                                                 │
│             │                                                                           │
│             ▼                                                                           │
│   ┌───────────────────┐                                                                 │
│   │  3. STREAMING     │  KVClient.StreamingRead([loc1, loc2, loc3, loc4, loc5])         │
│   │     READ          │  → gRPC bidi stream → Server → Parallel blob reads              │
│   │                   │  ← Returns: [chunk1, chunk2, chunk3, chunk4, chunk5]            │
│   └─────────┬─────────┘                                                                 │
│             │                                                                           │
│             ▼                                                                           │
│   ┌───────────────────┐                                                                 │
│   │  4. KV RESTORE    │  Model restores KV cache from chunks (skip recomputation)       │
│   │                   │  → 5 blocks × 128 tokens = 640 tokens restored                  │
│   │                   │  → Inference starts from token 641                              │
│   └─────────┬─────────┘                                                                 │
│             │                                                                           │
│             ▼                                                                           │
│   ┌───────────────────┐                                                                 │
│   │  5. INFERENCE     │  Model generates completion tokens                              │
│   │     [new tokens]  │                                                                 │
│   └─────────┬─────────┘                                                                 │
│             │                                                                           │
│             ▼                                                                           │
│   ┌───────────────────┐                                                                 │
│   │  6. WRITE         │  KVClient.Write(new_chunk) for each new 128-token block         │
│   │                   │  → gRPC → Server → Blob upload                                  │
│   │                   │  → Future lookups can reuse this cached data                    │
│   └───────────────────┘                                                                 │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Performance Optimizations

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                             PERFORMANCE ARCHITECTURE                                    │
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐│
│  │                              NUMA-AWARE DEPLOYMENT                                  ││
│  │                                                                                     ││
│  │   Azure FX96mds_v2 (96 cores, 2 NUMA nodes)                                        ││
│  │                                                                                     ││
│  │   ┌─────────────────────────────┐    ┌─────────────────────────────┐               ││
│  │   │       NUMA Node 0          │    │       NUMA Node 1          │               ││
│  │   │         48 cores           │    │         48 cores           │               ││
│  │   │                            │    │                            │               ││
│  │   │   KVStoreServer :8085      │    │   KVStoreServer :8086      │               ││
│  │   │   start /NODE 0            │    │   start /NODE 1            │               ││
│  │   │                            │    │                            │               ││
│  │   │   • Local memory access    │    │   • Local memory access    │               ││
│  │   │   • No cross-NUMA penalty  │    │   • No cross-NUMA penalty  │               ││
│  │   └─────────────────────────────┘    └─────────────────────────────┘               ││
│  │                                                                                     ││
│  │   Result: 2× throughput, consistent low latency                                    ││
│  │                                                                                     ││
│  └─────────────────────────────────────────────────────────────────────────────────────┘│
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐│
│  │                              GRPC OPTIMIZATIONS                                     ││
│  │                                                                                     ││
│  │   TCP_NODELAY=1              Disable Nagle's algorithm (no 40ms batching)          ││
│  │   KEEPALIVE_TIME=10s         Maintain warm connections                              ││
│  │   MAX_CONCURRENT_STREAMS=200 High parallelism per connection                        ││
│  │   MAX_FRAME_SIZE=16MB        Reduce framing overhead for 1.2MB payloads            ││
│  │   STREAM_WINDOW=64MB         Large flow control window                              ││
│  │                                                                                     ││
│  └─────────────────────────────────────────────────────────────────────────────────────┘│
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐│
│  │                            MULTI-NIC ROUND ROBIN                                    ││
│  │                                                                                     ││
│  │   ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐                                  ││
│  │   │NIC0 │ │NIC1 │ │NIC2 │ │NIC3 │ │NIC4 │ │NIC5 │                                  ││
│  │   └──┬──┘ └──┬──┘ └──┬──┘ └──┬──┘ └──┬──┘ └──┬──┘                                  ││
│  │      │       │       │       │       │       │                                      ││
│  │      └───────┴───────┴───┬───┴───────┴───────┘                                      ││
│  │                          │                                                          ││
│  │                          ▼                                                          ││
│  │                  Round-robin selection                                              ││
│  │                  (Custom Azure SDK fork)                                            ││
│  │                                                                                     ││
│  │   Result: 6× aggregate bandwidth to storage                                         ││
│  │                                                                                     ││
│  └─────────────────────────────────────────────────────────────────────────────────────┘│
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Current Deployment Model

The KV Store Service is deployed using **Service Fabric Managed Clusters (SFMC)** with the **BYOVNET + BYOLB** pattern (Bring Your Own VNet + Bring Your Own Load Balancer).

### Key Components

| Component | Description |
|-----------|-------------|
| **SF Managed Cluster** | Standard SKU with 2 node types (System + App) |
| **System Node Type** | 5 VMs for SF system services, public LB for management |
| **App Node Type** | 3+ VMs running KVStoreServer, internal LB for gRPC traffic |
| **Internal Load Balancer** | Regional endpoint (e.g., `10.0.0.4:8085`) for private access |
| **VNet Peering** | Customers connect via VNet peering (no public internet) |
| **UAMI** | User-Assigned Managed Identity for storage access |

### Customer Connectivity

Customers connect via **VNet peering** instead of Private Link (PLINK):

```
Customer VNet ──VNet Peering──► KVStore VNet ──► Internal LB ──► App VMs
```

For detailed topology, see [TOPOLOGY.md](TOPOLOGY.md).

---

## Deployment Topology

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                   AZURE PLATFORM SUBSCRIPTION                                           │
│                                  (Multi-Region KV Store Service)                                        │
│                                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐│
│  │                                    REGION: WEST US 2                                                ││
│  │                                                                                                     ││
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐   ││
│  │   │                                   KV Store Cluster #1                                       │   ││
│  │   │                                                                                             │   ││
│  │   │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐        │   ││
│  │   │   │  Windows VM #1  │  │  Windows VM #2  │  │  Windows VM #3  │  │  Windows VM #N  │        │   ││
│  │   │   │  FX96mds_v2     │  │  FX96mds_v2     │  │  FX96mds_v2     │  │  FX96mds_v2     │        │   ││
│  │   │   │  ┌────┐ ┌────┐  │  │  ┌────┐ ┌────┐  │  │  ┌────┐ ┌────┐  │  │  ┌────┐ ┌────┐  │        │   ││
│  │   │   │  │8085│ │8086│  │  │  │8085│ │8086│  │  │  │8085│ │8086│  │  │  │8085│ │8086│  │        │   ││
│  │   │   │  │N0  │ │N1  │  │  │  │N0  │ │N1  │  │  │  │N0  │ │N1  │  │  │  │N0  │ │N1  │  │        │   ││
│  │   │   │  └────┘ └────┘  │  │  └────┘ └────┘  │  │  └────┘ └────┘  │  │  └────┘ └────┘  │        │   ││
│  │   │   └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘        │   ││
│  │   │                                                                                             │   ││
│  │   └─────────────────────────────────────────────────────────────────────────────────────────────┘   ││
│  │                                                                                                     ││
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐   ││
│  │   │                                   KV Store Cluster #2                                       │   ││
│  │   │                                        (similar)                                            │   ││
│  │   └─────────────────────────────────────────────────────────────────────────────────────────────┘   ││
│  │                                                                                                     ││
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────┘│
│                                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐│
│  │                                    REGION: EAST US                                                  ││
│  │                                                                                                     ││
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐   ││
│  │   │                                   KV Store Cluster #1                                       │   ││
│  │   │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐        │   ││
│  │   │   │  Windows VM     │  │  Windows VM     │  │  Windows VM     │  │  Windows VM     │        │   ││
│  │   │   │  (2 processes)  │  │  (2 processes)  │  │  (2 processes)  │  │  (2 processes)  │        │   ││
│  │   │   └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘        │   ││
│  │   └─────────────────────────────────────────────────────────────────────────────────────────────┘   ││
│  │                                                                                                     ││
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────┘│
│                                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐│
│  │                                    REGION: WEST EUROPE                                              ││
│  │                                        (similar)                                                    ││
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────┘│
│                                                                                                         │
│                                              │ Private Endpoints                                        │
│                                              ▼                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐│
│  │                              CUSTOMER STORAGE ACCOUNTS                                              ││
│  │                          (Multiple Customer Subscriptions)                                          ││
│  │                                                                                                     ││
│  │   ┌───────────────────┐  ┌───────────────────┐  ┌───────────────────┐  ┌───────────────────┐        ││
│  │   │  Customer A       │  │  Customer B       │  │  Customer C       │  │  Customer N       │        ││
│  │   │  Storage Account  │  │  Storage Account  │  │  Storage Account  │  │  Storage Account  │        ││
│  │   └───────────────────┘  └───────────────────┘  └───────────────────┘  └───────────────────┘        ││
│  │                                                                                                     ││
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────┘│
│                                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                              ▲
                                              │ Private Link (Single PLINK per Provider)
                                              │
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              MODEL PROVIDER INFRASTRUCTURE                                              │
│                          (Multiple Tenants - Different Subscriptions)                                   │
│                                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                     Provider A                                                  │   │
│   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                            │   │
│   │   │  GPU Node   │  │  GPU Node   │  │  GPU Node   │  │  GPU Node   │                            │   │
│   │   │  KVClient   │  │  KVClient   │  │  KVClient   │  │  KVClient   │                            │   │
│   │   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘                            │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                     Provider B                                                  │   │
│   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                            │   │
│   │   │  GPU Node   │  │  GPU Node   │  │  GPU Node   │  │  GPU Node   │                            │   │
│   │   │  KVClient   │  │  KVClient   │  │  KVClient   │  │  KVClient   │                            │   │
│   │   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘                            │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Network Connectivity Detail

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    NETWORK ARCHITECTURE                                                 │
│                                                                                                         │
│   ┌───────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│   │                         MODEL PROVIDER SUBSCRIPTION                                               │ │
│   │                                                                                                   │ │
│   │   ┌───────────────────────────────────────────────────────────────────────────────────────────┐   │ │
│   │   │                              Inference VNET                                               │   │ │
│   │   │                                                                                           │   │ │
│   │   │   GPU Node 1    GPU Node 2    GPU Node 3    GPU Node 4         GPU Node N                 │   │ │
│   │   │       │              │              │              │                │                     │   │ │
│   │   │       └──────────────┴──────────────┴──────────────┴────────────────┘                     │   │ │
│   │   │                                     │                                                     │   │ │
│   │   │                                     │                                                     │   │ │
│   │   └─────────────────────────────────────┼─────────────────────────────────────────────────────┘   │ │
│   │                                         │                                                         │ │
│   │                              ┌──────────┴──────────┐                                              │ │
│   │                              │    Private Link     │                                              │ │
│   │                              │  (Single PLINK to   │                                              │ │
│   │                              │   KV Store Service) │                                              │ │
│   │                              └──────────┬──────────┘                                              │ │
│   │                                         │                                                         │ │
│   └─────────────────────────────────────────┼─────────────────────────────────────────────────────────┘ │
│                                             │                                                           │
│   ┌─────────────────────────────────────────┼─────────────────────────────────────────────────────────┐ │
│   │                         AZURE PLATFORM SUBSCRIPTION                                               │ │
│   │                                         │                                                         │ │
│   │   ┌─────────────────────────────────────┼─────────────────────────────────────────────────────┐   │ │
│   │   │                              KV Store VNET                                                │   │ │
│   │   │                                     │                                                     │   │ │
│   │   │                              ┌──────┴──────┐                                              │   │ │
│   │   │                              │    Load     │                                              │   │ │
│   │   │                              │  Balancer   │                                              │   │ │
│   │   │                              └──────┬──────┘                                              │   │ │
│   │   │                                     │                                                     │   │ │
│   │   │       ┌────────────────┬────────────┼────────────┬────────────────┐                       │   │ │
│   │   │       │                │            │            │                │                       │   │ │
│   │   │   ┌───┴───┐        ┌───┴───┐    ┌───┴───┐    ┌───┴───┐        ┌───┴───┐                   │   │ │
│   │   │   │ VM #1 │        │ VM #2 │    │ VM #3 │    │ VM #4 │        │ VM #N │                   │   │ │
│   │   │   │ :8085 │        │ :8085 │    │ :8085 │    │ :8085 │        │ :8085 │                   │   │ │
│   │   │   │ :8086 │        │ :8086 │    │ :8086 │    │ :8086 │        │ :8086 │                   │   │ │
│   │   │   └───┬───┘        └───┬───┘    └───┬───┘    └───┬───┘        └───┬───┘                   │   │ │
│   │   │       │                │            │            │                │                       │   │ │
│   │   │       └────────────────┴────────────┼────────────┴────────────────┘                       │   │ │
│   │   │                                     │                                                     │   │ │
│   │   └─────────────────────────────────────┼─────────────────────────────────────────────────────┘   │ │
│   │                                         │                                                         │ │
│   │                              ┌──────────┴──────────┐                                              │ │
│   │                              │  Private Endpoints  │                                              │ │
│   │                              │  (to Customer       │                                              │ │
│   │                              │   Storage Accounts) │                                              │ │
│   │                              └──────────┬──────────┘                                              │ │
│   │                                         │                                                         │ │
│   └─────────────────────────────────────────┼─────────────────────────────────────────────────────────┘ │
│                                             │                                                           │
│   ┌─────────────────────────────────────────┼─────────────────────────────────────────────────────────┐ │
│   │                         CUSTOMER SUBSCRIPTIONS                                                    │ │
│   │                                         │                                                         │ │
│   │       ┌─────────────────┬───────────────┼───────────────┬─────────────────┐                       │ │
│   │       │                 │               │               │                 │                       │ │
│   │   ┌───┴────┐        ┌───┴────┐      ┌───┴────┐      ┌───┴────┐        ┌───┴────┐                  │ │
│   │   │Customer│        │Customer│      │Customer│      │Customer│        │Customer│                  │ │
│   │   │   A    │        │   B    │      │   C    │      │   D    │        │   N    │                  │ │
│   │   │Storage │        │Storage │      │Storage │      │Storage │        │Storage │                  │ │
│   │   └────────┘        └────────┘      └────────┘      └────────┘        └────────┘                  │ │
│   │                                                                                                   │ │
│   └───────────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Summary

| Feature | Description |
|---------|-------------|
| **Multi-Tenant** | Serves multiple customers from shared Azure Platform infrastructure |
| **Multi-Region** | Deployed across Azure regions (West US, East US, West Europe, etc.) |
| **Multi-Cluster** | Each region has multiple clusters for scalability and HA |
| **Cluster Composition** | Array of Windows VMs, each running 2 NUMA-pinned processes |
| **Unified Endpoint** | Single gRPC service handles multiple storage accounts - reduces PLINK complexity |
| **Account Resolution** | `IAccountResolver` interface resolves resource names to storage connections |
| **High Performance** | NUMA-aware, multi-NIC, async gRPC with streaming |
| **Scalability** | Multi-process (2 per VM), multi-VM (N per cluster), multi-cluster (N per region) |
| **Cross-Region (Future)** | Cache replication across regions for global deployments |
| **Protocol** | gRPC/HTTP2 with optimized settings for large payloads |

---

## Capacity Planning

| Level | Component | Capacity |
|-------|-----------|----------|
| **Process** | KVStoreServer | 48 cores (1 NUMA node), ~100 concurrent streams |
| **VM** | FX96mds_v2 | 2 processes × 48 cores = 96 cores, ~200 concurrent streams |
| **Cluster** | N VMs | N × 200 streams, horizontal scale |
| **Region** | N Clusters | N × cluster capacity, geo-redundancy |
| **Global** | N Regions | Worldwide coverage, latency optimization |

---

*Last updated: December 2025*
