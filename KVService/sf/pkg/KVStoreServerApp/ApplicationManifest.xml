<?xml version="1.0" encoding="utf-8"?>
<ApplicationManifest ApplicationTypeName="KVStoreServerAppType" ApplicationTypeVersion="1.0.28" xmlns="http://schemas.microsoft.com/2011/01/fabric" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <Description>KVStore Server Application with dual-port NUMA deployment (Port 8085 NUMA0, Port 8086 NUMA1)</Description>
  
  <Parameters>
    <Parameter Name="KVStoreServer_InstanceCount" DefaultValue="-1" />
    <Parameter Name="AZURE_STORAGE_BLOB_DNS_SUFFIX" DefaultValue=".blob.core.windows.net" />
    <Parameter Name="KVSTORE_LOG_LEVEL" DefaultValue="error" />
    <Parameter Name="ManagedIdentityClientId" DefaultValue="" />
    <Parameter Name="GrpcPortNuma0" DefaultValue="8085" />
    <Parameter Name="GrpcPortNuma1" DefaultValue="8086" />
    <Parameter Name="ConfigurationStore" DefaultValue="" />
    <Parameter Name="ConfigurationContainer" DefaultValue="dataplane-metadata" />
    <Parameter Name="CurrentLocation" DefaultValue="" />
  </Parameters>
  
  <!-- Service for NUMA Node 0 (Port 8085) -->
  <ServiceManifestImport>
    <ServiceManifestRef ServiceManifestName="KVStoreServerNode0Pkg" ServiceManifestVersion="1.0.28" />
    <EnvironmentOverrides CodePackageRef="Code">
      <EnvironmentVariable Name="AZURE_STORAGE_BLOB_DNS_SUFFIX" Value="[AZURE_STORAGE_BLOB_DNS_SUFFIX]" />
      <EnvironmentVariable Name="KVSTORE_LOG_LEVEL" Value="[KVSTORE_LOG_LEVEL]" />
      <EnvironmentVariable Name="KVSTORE_PORT" Value="[GrpcPortNuma0]" />
      <EnvironmentVariable Name="KVSTORE_NUMA_NODE" Value="0" />
      <EnvironmentVariable Name="KVSTORE_NIC_INDEX" Value="0" />
      <EnvironmentVariable Name="KV_CURRENT_LOCATION" Value="[CurrentLocation]" />
      <EnvironmentVariable Name="KV_CONFIGURATION_STORE" Value="[ConfigurationStore]" />
      <EnvironmentVariable Name="KV_CONFIGURATION_CONTAINER" Value="[ConfigurationContainer]" />
      <EnvironmentVariable Name="AZURE_CLIENT_ID" Value="[ManagedIdentityClientId]" />
    </EnvironmentOverrides>
    <Policies>
      <RunAsPolicy CodePackageRef="Code" UserRef="LocalAdmin" EntryPointType="All" />
    </Policies>
  </ServiceManifestImport>
  
  <!-- Service for NUMA Node 1 (Port 8086) -->
  <ServiceManifestImport>
    <ServiceManifestRef ServiceManifestName="KVStoreServerNode1Pkg" ServiceManifestVersion="1.0.28" />
    <EnvironmentOverrides CodePackageRef="Code">
      <EnvironmentVariable Name="AZURE_STORAGE_BLOB_DNS_SUFFIX" Value="[AZURE_STORAGE_BLOB_DNS_SUFFIX]" />
      <EnvironmentVariable Name="KVSTORE_LOG_LEVEL" Value="[KVSTORE_LOG_LEVEL]" />
      <EnvironmentVariable Name="KVSTORE_PORT" Value="[GrpcPortNuma1]" />
      <EnvironmentVariable Name="KVSTORE_NUMA_NODE" Value="1" />
      <EnvironmentVariable Name="KVSTORE_NIC_INDEX" Value="0" />
      <EnvironmentVariable Name="KV_CURRENT_LOCATION" Value="[CurrentLocation]" />
      <EnvironmentVariable Name="KV_CONFIGURATION_STORE" Value="[ConfigurationStore]" />
      <EnvironmentVariable Name="KV_CONFIGURATION_CONTAINER" Value="[ConfigurationContainer]" />
      <EnvironmentVariable Name="AZURE_CLIENT_ID" Value="[ManagedIdentityClientId]" />
    </EnvironmentOverrides>
    <Policies>
      <RunAsPolicy CodePackageRef="Code" UserRef="LocalAdmin" EntryPointType="All" />
    </Policies>
  </ServiceManifestImport>
  
  <DefaultServices>
    <!-- Service instance on NUMA Node 0 -->
    <Service Name="KVStoreServerNode0" ServicePackageActivationMode="ExclusiveProcess">
      <StatelessService ServiceTypeName="KVStoreServerNode0Type" InstanceCount="1">
        <SingletonPartition />
        <PlacementConstraints>NodeType == App</PlacementConstraints>
      </StatelessService>
    </Service>
    
    <!-- Service instance on NUMA Node 1 -->
    <Service Name="KVStoreServerNode1" ServicePackageActivationMode="ExclusiveProcess">
      <StatelessService ServiceTypeName="KVStoreServerNode1Type" InstanceCount="1">
        <SingletonPartition />
        <PlacementConstraints>NodeType == App</PlacementConstraints>
      </StatelessService>
    </Service>
  </DefaultServices>
  
  <Principals>
    <Users>
      <User Name="LocalAdmin" AccountType="LocalSystem" />
    </Users>
  </Principals>
</ApplicationManifest>





























